#!/bin/bash

# Vercel環境変数からconfig.jsを生成するビルドスクリプト
# APIキーは全てVercel環境変数から注入し、ソースコードには含めない
#
# 必要な環境変数:
#   GEMINI_API_KEY              - Gemini APIキー（Drive APIにも使用）
#   GOOGLE_DRIVE_CLIENT_ID      - Google OAuth 2.0 クライアントID

echo "Generating config.js from environment variables..."

# Gemini API Key（Drive APIキーとしても使用）
[ -z "$GEMINI_API_KEY" ] && echo "Warning: GEMINI_API_KEY is not set."

# Google Drive Client ID
[ -z "$GOOGLE_DRIVE_CLIENT_ID" ] && echo "ERROR: GOOGLE_DRIVE_CLIENT_ID is not set. Google Drive保存が動作しません。"

# Google Drive API Key - 未設定ならGEMINI_API_KEYを使用（同一キー運用）
[ -z "$GOOGLE_DRIVE_API_KEY" ] && GOOGLE_DRIVE_API_KEY="$GEMINI_API_KEY"

# TARGET_FOLDER_IDは常に空。ユーザーがGoogle Pickerでフォルダを選択する仕様。
cat > config.js << CONFIGEOF
// Auto-generated from environment variables at build time
// Do not edit this file directly

const API_CONFIG = {
    GEMINI_API_KEY: '${GEMINI_API_KEY}',
    MODEL_NAME: 'gemini-2.5-flash'
};

// Google Drive設定
// CLIENT_IDとAPI_KEYはVercel環境変数から注入
// TARGET_FOLDER_IDはユーザーがGoogle Pickerで選択（localStorageに保存される）
const DRIVE_CONFIG = {
    CLIENT_ID: '${GOOGLE_DRIVE_CLIENT_ID}',
    API_KEY: '${GOOGLE_DRIVE_API_KEY}',
    TARGET_FOLDER_ID: ''
};
CONFIGEOF

echo "config.js generated successfully!"

# 設定内容の確認出力
echo "  GEMINI_API_KEY: $([ -n "$GEMINI_API_KEY" ] && echo 'SET' || echo 'NOT SET')"
echo "  GOOGLE_DRIVE_CLIENT_ID: $([ -n "$GOOGLE_DRIVE_CLIENT_ID" ] && echo 'SET' || echo 'NOT SET')"
echo "  GOOGLE_DRIVE_API_KEY: $([ -n "$GOOGLE_DRIVE_API_KEY" ] && echo 'SET' || echo 'NOT SET')"
