<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カラーズFC アセスメント管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .main-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .action-card h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .action-card p {
            color: #666;
            font-size: 14px;
        }

        .children-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .children-list h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .child-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            transition: border-color 0.3s;
        }

        .child-item:hover {
            border-color: #4caf50;
        }

        .child-info h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .child-info p {
            color: #666;
            font-size: 14px;
            margin: 4px 0;
        }

        .child-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .btn-secondary {
            background: #4caf50;
            color: white;
        }

        .btn-tertiary {
            background: #ff9800;
            color: white;
        }

        .btn-quaternary {
            background: #2196f3;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-content h2 {
            color: #2e7d32;
            margin-bottom: 20px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* 一覧表示スタイル */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .list-item:hover {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .list-item-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .list-item-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .list-item-actions {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 28px;
            }

            .child-item {
                grid-template-columns: 1fr;
            }

            .child-actions {
                justify-content: flex-start;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .list-item-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>カラーズFC アセスメント管理システム</h1>
            <p>お子様の特性管理・支援計画・日々の記録を一元管理</p>
        </header>

        <div class="main-actions">
            <div class="action-card" onclick="window.location.href='assessment/form.html'">
                <h3>新規アセスメント作成</h3>
                <p>新しいお子様のアセスメントシートを作成します</p>
            </div>
            <div class="action-card" onclick="showAllAssessments()">
                <h3>アセスメント一覧</h3>
                <p>登録済みのアセスメントシートを確認します</p>
            </div>
            <div class="action-card" onclick="showAllSupportPlans()">
                <h3>支援計画一覧</h3>
                <p>作成済みの支援計画を確認します</p>
            </div>
            <div class="action-card" onclick="showAllReports()">
                <h3>成長記録一覧</h3>
                <p>日々の記録と成長の振り返りを確認します</p>
            </div>
        </div>

        <div class="children-list">
            <h2>登録児童一覧</h2>
            <div id="childrenContainer">
                <div class="empty-state">
                    <h3>まだ登録されている児童はいません</h3>
                    <p>「新規アセスメント作成」から始めてください</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing assessment -->
    <div id="assessmentModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('assessmentModal')">&times;</span>
            <div id="assessmentContent"></div>
        </div>
    </div>

    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- config.jsは存在する場合のみ読み込む（デプロイ時に自動生成される） -->
    <script>
        // 最初に空のAPI_CONFIGを定義（デフォルト値）
        window.API_CONFIG = {
            GEMINI_API_KEY: '',
            MODEL_NAME: 'gemini-2.0-flash-exp'
        };
    </script>
    <script src="config.js" onerror="console.log('config.js not found - using default API_CONFIG')"></script>
    <script src="google-drive-api.js"></script>
    <script src="gemini-api.js"></script>
    <script>
        // APIキーを読み込み
        document.addEventListener('DOMContentLoaded', function() {
            geminiAPI.loadApiKey();
            loadChildren();
        });

        // Load and display children
        function loadChildren() {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const container = document.getElementById('childrenContainer');

            if (Object.keys(assessments).length === 0) {
                return;
            }

            container.innerHTML = '';

            Object.entries(assessments).forEach(([fileName, assessment]) => {
                const childData = assessment.data;
                const childItem = document.createElement('div');
                childItem.className = 'child-item';
                childItem.innerHTML = `
                    <div class="child-info">
                        <h3>${childData.childName}（${childData.childNameKana}）</h3>
                        <p>生年月日: ${childData.birthDate} | 性別: ${childData.gender || '未回答'}</p>
                        <p>診断名: ${childData.diagnosis || 'なし'}</p>
                        <p>登録日: ${new Date(assessment.createdAt).toLocaleDateString('ja-JP')}</p>
                    </div>
                    <div class="child-actions">
                        <button class="btn btn-primary" onclick="viewAssessment('${fileName}')">アセスメント表示</button>
                        <button class="btn btn-secondary" onclick="generateSupportPlan('${fileName}')">支援計画作成</button>
                        <button class="btn btn-tertiary" onclick="createDailyReport('${fileName}')">日々の記録</button>
                        <button class="btn btn-quaternary" onclick="createReview('${fileName}')">成長振り返り</button>
                    </div>
                `;
                container.appendChild(childItem);
            });
        }

        window.viewAssessment = function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');
            content.innerHTML = assessment.html;
            modal.classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.generateSupportPlan = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('アセスメントデータが見つかりません');
                return;
            }

            const confirmMsg = `${assessment.data.childName}さんの支援計画を作成します。よろしいですか？`;
            if (!confirm(confirmMsg)) return;

            try {
                // 日付関連の変数
                const today = new Date();
                const startDate = today.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '年').replace(/年(\d+)$/, '月$1日');
                const endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '年').replace(/年(\d+)$/, '月$1日');

                // Generate support plan using Gemini API
                const prompt = `
あなたは放課後等デイサービスの児童発達支援管理責任者です。
以下のアセスメント情報を分析し、公式様式に準拠した個別支援計画をJSON形式で作成してください。

【重要な指示】
- 必ずJSON形式のみを出力してください（説明文は不要）
- すべての項目に具体的な内容を記載してください
- 「ー」や空文字列は使用しないでください
- サッカー療育の文脈で記載してください

【児童情報】
児童名: ${assessment.data.childName}
診断名: ${assessment.data.diagnosis || '発達に課題のあるお子様'}

【アセスメント評価結果】
- 場面や指示の理解: ${assessment.data.situationEpisode || '個別の状況に応じた支援が必要'}
- 共感性: ${assessment.data.empathyEpisode || '他者理解の練習が必要'}
- 社会的ルール: ${assessment.data.cooperation || '集団活動での支援が必要'}
- コミュニケーション: ${assessment.data.communicationDetails || 'コミュニケーション支援が必要'}
- こだわり: ${assessment.data.persistence || '柔軟性の支援が必要'}
- 指示の受け入れ: ${assessment.data.instructionDetails || '指示理解の支援が必要'}
- 集中力: ${assessment.data.concentrationDetails || '集中力の維持支援が必要'}
- 多動性: ${assessment.data.hyperactivityDetails || '活動量の調整支援が必要'}
- 衝動性: ${assessment.data.impulsivityDetails || '衝動コントロールの支援が必要'}
- パニック: ${assessment.data.panicDetails || '感情コントロールの支援が必要'}
- 粗大運動: ${assessment.data.grossMotorDetails || '運動機能の支援が必要'}
- 微細運動: ${assessment.data.fineMotorDetails || '手先の器用さの支援が必要'}
- バランス: ${assessment.data.balanceDetails || 'バランス能力の支援が必要'}
- 生活習慣: ${assessment.data.dailyLivingDetails || '生活習慣の支援が必要'}
- 家庭での配慮: ${assessment.data.familySupport || '家庭との連携が必要'}

【出力形式】
以下のJSON形式で出力してください：
{
  "selfIntent": "本人の生活に対する意向（サッカーを楽しみたい等）",
  "familyIntent": "家族の生活に対する意向（感情のコントロールを学んでほしい等）",
  "supportPolicy": "総合的な支援の方針（200文字程度）",
  "longTermGoal": "長期目標（具体的な達成目標）",
  "shortTermGoal": "短期目標（3ヶ月程度で達成できる目標）",
  "selfSupport": [
    {
      "needs": "本人のニーズ1（例：自分の感情を理解し表現できるようになりたい）",
      "goal": "具体的な達成目標1",
      "content": "支援内容（5領域との関連を含む具体的な内容）",
      "period": "6ヶ月",
      "staff": "カラーズFCスタッフ、保護者",
      "notes": "留意事項（本人の役割を含む）",
      "priority": 1
    },
    {
      "needs": "本人のニーズ2",
      "goal": "具体的な達成目標2",
      "content": "支援内容2",
      "period": "6ヶ月",
      "staff": "カラーズFCスタッフ",
      "notes": "留意事項2",
      "priority": 2
    },
    {
      "needs": "本人のニーズ3",
      "goal": "具体的な達成目標3",
      "content": "支援内容3",
      "period": "6ヶ月",
      "staff": "カラーズFCスタッフ",
      "notes": "留意事項3",
      "priority": 3
    }
  ],
  "familySupport": {
    "needs": "家族支援のニーズ",
    "goal": "具体的な達成目標",
    "content": "支援内容",
    "period": "6ヶ月",
    "staff": "カラーズFCスタッフ",
    "notes": "留意事項"
  },
  "transitionSupport": {
    "needs": "移行支援のニーズ",
    "goal": "具体的な達成目標",
    "content": "支援内容",
    "period": "6ヶ月",
    "staff": "カラーズFCスタッフ、学校の先生",
    "notes": "留意事項"
  }
}

JSONのみを出力してください。`;

                const response = await geminiAPI.generateContent(prompt);

                // JSONを抽出
                let planData;
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        planData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('JSON not found in response');
                    }
                } catch (e) {
                    console.error('JSON parse error:', e);
                    alert('支援計画の生成に失敗しました。再度お試しください。');
                    return;
                }

                // 公式様式のHTMLを生成
                const supportPlanHTML = generateOfficialSupportPlanHTML(assessment.data, planData, startDate, endDate);

                // Save support plan
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const planFileName = `${assessment.data.childName}_支援計画_${new Date().toISOString().split('T')[0]}.html`;
                supportPlans[planFileName] = {
                    html: supportPlanHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    planData: planData,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('supportPlans', JSON.stringify(supportPlans));

                alert('支援計画が作成されました！');

                // Display the plan
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = supportPlanHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error generating support plan:', error);
                alert('支援計画の作成に失敗しました。もう一度お試しください。');
            }
        };

        // 公式様式の支援計画HTMLを生成
        function generateOfficialSupportPlanHTML(childData, planData, startDate, endDate) {
            const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');

            return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${childData.childName}さんの個別支援計画</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif; font-size: 12px; line-height: 1.4; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .header-left h1 { font-size: 18px; color: #333; margin-bottom: 5px; }
        .header-right { text-align: right; font-size: 11px; color: #666; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .info-table th, .info-table td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
        .info-table th { background: #f0f0f0; font-weight: bold; width: 120px; }
        .section-title { background: #ff9800; color: white; padding: 8px 12px; font-weight: bold; margin: 15px 0 10px; }
        .content-row { display: flex; margin-bottom: 10px; }
        .content-label { width: 150px; font-weight: bold; padding: 8px; background: #fff8e1; border: 1px solid #ddd; }
        .content-value { flex: 1; padding: 8px; border: 1px solid #ddd; border-left: none; }
        .support-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
        .support-table th { background: #ff9800; color: white; padding: 8px; border: 1px solid #e65100; text-align: center; font-weight: bold; }
        .support-table td { padding: 8px; border: 1px solid #ddd; vertical-align: top; }
        .support-table .category { background: #fff8e1; font-weight: bold; text-align: center; width: 60px; }
        .support-table .needs { width: 120px; }
        .support-table .goal { width: 150px; }
        .support-table .content { width: 280px; }
        .support-table .period { width: 60px; text-align: center; }
        .support-table .staff { width: 100px; }
        .support-table .notes { width: 180px; }
        .support-table .priority { width: 40px; text-align: center; }
        .footer { margin-top: 30px; display: flex; justify-content: space-between; }
        .footer-left, .footer-right { width: 45%; }
        .signature-row { display: flex; margin-bottom: 10px; }
        .signature-label { width: 100px; }
        .signature-line { flex: 1; border-bottom: 1px solid #333; }
        @media print { body { padding: 0; background: white; } .container { box-shadow: none; padding: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>${childData.childName}さんの個別支援計画（代替支援用）</h1>
            </div>
            <div class="header-right">
                <p>施設名：カラーズFC鳥栖</p>
                <p>利用サービス：放課後等デイサービス</p>
                <p>作成日：${today}</p>
            </div>
        </div>

        <table class="info-table">
            <tr>
                <th>受給者証番号</th>
                <td style="width:150px;"></td>
                <th>開始日</th>
                <td style="width:120px;">${startDate}</td>
                <th>有効期限</th>
                <td style="width:120px;">${endDate}</td>
                <th>作成回数</th>
                <td style="width:60px;">1</td>
            </tr>
        </table>

        <div class="content-row">
            <div class="content-label">利用児及び家族の<br>生活に対する意向</div>
            <div class="content-value">
                <strong>本人：</strong>${planData.selfIntent}<br>
                <strong>家族：</strong>${planData.familyIntent}
            </div>
        </div>

        <div class="content-row">
            <div class="content-label">総合的な支援の方針</div>
            <div class="content-value">${planData.supportPolicy}</div>
        </div>

        <div class="content-row">
            <div class="content-label">長期目標（内容・期間等）</div>
            <div class="content-value">${planData.longTermGoal}</div>
            <div class="content-label" style="width:180px;border-left:none;">支援の標準的な提供時間等<br>（曜日・頻度、時間）</div>
        </div>

        <div class="content-row">
            <div class="content-label">短期目標（内容・期間等）</div>
            <div class="content-value">${planData.shortTermGoal}</div>
            <div class="content-value" style="width:180px;border-left:none;">毎週月・金曜日 12:30〜18:00<br>休校日 10:00〜15:00</div>
        </div>

        <table class="support-table">
            <thead>
                <tr>
                    <th colspan="2">項目（本人のニーズ等）</th>
                    <th>具体的な達成目標</th>
                    <th>支援内容<br>（内容・支援の提供上のポイント・5領域との関連性等）</th>
                    <th>達成時期</th>
                    <th>担当者<br>提供機関</th>
                    <th>留意事項<br>（本人の役割を含む）</th>
                    <th>優先順位</th>
                </tr>
            </thead>
            <tbody>
                ${planData.selfSupport.map((item, index) => `
                <tr>
                    ${index === 0 ? `<td class="category" rowspan="${planData.selfSupport.length}">本人支援</td>` : ''}
                    <td class="needs">${item.needs}</td>
                    <td class="goal">${item.goal}</td>
                    <td class="content">${item.content}</td>
                    <td class="period">${item.period}</td>
                    <td class="staff">${item.staff}</td>
                    <td class="notes">${item.notes}</td>
                    <td class="priority">${item.priority}</td>
                </tr>
                `).join('')}
                <tr>
                    <td class="category">家族支援</td>
                    <td class="needs">${planData.familySupport.needs}</td>
                    <td class="goal">${planData.familySupport.goal}</td>
                    <td class="content">${planData.familySupport.content}</td>
                    <td class="period">${planData.familySupport.period}</td>
                    <td class="staff">${planData.familySupport.staff}</td>
                    <td class="notes">${planData.familySupport.notes}</td>
                    <td class="priority"></td>
                </tr>
                <tr>
                    <td class="category">移行支援</td>
                    <td class="needs">${planData.transitionSupport.needs}</td>
                    <td class="goal">${planData.transitionSupport.goal}</td>
                    <td class="content">${planData.transitionSupport.content}</td>
                    <td class="period">${planData.transitionSupport.period}</td>
                    <td class="staff">${planData.transitionSupport.staff}</td>
                    <td class="notes">${planData.transitionSupport.notes}</td>
                    <td class="priority"></td>
                </tr>
            </tbody>
        </table>

        <div class="footer">
            <div class="footer-left">
                <div class="signature-row">
                    <span class="signature-label">説明同意日</span>
                    <span>令和　　年　　月　　日</span>
                </div>
                <div class="signature-row">
                    <span class="signature-label">保護者氏名</span>
                    <span class="signature-line"></span>
                </div>
            </div>
            <div class="footer-right">
                <p>カラーズFC鳥栖</p>
                <div class="signature-row">
                    <span class="signature-label">児童発達支援管理責任者</span>
                    <span style="margin-left:20px;">岡本　陸佑</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        window.createDailyReport = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('アセスメントデータが見つかりません');
                return;
            }

            const activity = prompt(`${assessment.data.childName}さんの本日の活動内容を入力してください:`);
            if (!activity) return;

            const observation = prompt('本日の様子や気づいたことを入力してください:');
            if (!observation) return;

            try {
                // Get latest support plan
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const childPlans = Object.entries(supportPlans)
                    .filter(([key, plan]) => plan.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));

                const latestPlan = childPlans[0]?.[1];

                const prompt = `
児童発達支援の日々の指導記録を作成してください。

児童名: ${assessment.data.childName}
日付: ${new Date().toLocaleDateString('ja-JP')}

【本日の活動】
${activity}

【観察内容】
${observation}

【参考情報】
アセスメント情報:
- 診断名: ${assessment.data.diagnosis || 'なし'}
- 主な特性: ${assessment.data.situationEpisode}, ${assessment.data.communicationDetails}

${latestPlan ? `支援計画目標: ${latestPlan.html}` : ''}

【記録に含める内容】
1. 活動内容
2. 児童の反応と様子
3. 支援計画との関連
4. 成長が見られた点
5. 今後の支援で注意すべき点

HTMLフォーマットで、見やすく整理された日々の記録を作成してください。
`;

                const reportHTML = await geminiAPI.generateContent(prompt);

                // Save daily report
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                const reportFileName = `${assessment.data.childName}_記録_${new Date().toISOString().split('T')[0]}.html`;
                dailyReports[reportFileName] = {
                    html: reportHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    activity: activity,
                    observation: observation,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('dailyReports', JSON.stringify(dailyReports));

                alert('日々の記録が作成されました！');

                // Display the report
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = reportHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error creating daily report:', error);
                alert('日々の記録の作成に失敗しました。もう一度お試しください。');
            }
        };

        window.createReview = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('アセスメントデータが見つかりません');
                return;
            }

            const confirmMsg = `${assessment.data.childName}さんの成長の振り返りを作成します。よろしいですか？`;
            if (!confirm(confirmMsg)) return;

            try {
                // Get all related data
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');

                const childPlans = Object.entries(supportPlans)
                    .filter(([key, plan]) => plan.childName === assessment.data.childName);

                const childReports = Object.entries(dailyReports)
                    .filter(([key, report]) => report.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .slice(0, 10); // Last 10 reports

                const previousReviews = Object.entries(reviews)
                    .filter(([key, review]) => review.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));

                const prompt = `
児童発達支援の成長の振り返りレポートを作成してください。

児童名: ${assessment.data.childName}
作成日: ${new Date().toLocaleDateString('ja-JP')}

【アセスメント情報】
診断名: ${assessment.data.diagnosis || 'なし'}
主な特性:
- ${assessment.data.situationEpisode}
- ${assessment.data.communicationDetails}

【支援計画】
${childPlans.map(([key, plan]) => plan.html).join('\n')}

【最近の活動記録（直近10件）】
${childReports.map(([key, report]) => `
日付: ${new Date(report.createdAt).toLocaleDateString('ja-JP')}
活動: ${report.activity}
観察: ${report.observation}
`).join('\n')}

${previousReviews.length > 0 ? `
【過去の振り返り】
${previousReviews[0][1].html}
` : ''}

【振り返りレポートに含める内容】
1. この期間の全体的な成長の様子
2. 支援計画の達成状況
3. 特に成長が見られた領域
4. まだ支援が必要な領域
5. 今後の支援の方向性
6. 保護者へのフィードバック

HTMLフォーマットで、グラフや表を使用して視覚的に分かりやすい振り返りレポートを作成してください。
`;

                const reviewHTML = await geminiAPI.generateContent(prompt);

                // Save review
                const reviewFileName = `${assessment.data.childName}_振り返り_${new Date().toISOString().split('T')[0]}.html`;
                reviews[reviewFileName] = {
                    html: reviewHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('reviews', JSON.stringify(reviews));

                alert('成長の振り返りが作成されました！');

                // Display the review
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = reviewHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error creating review:', error);
                alert('成長の振り返りの作成に失敗しました。もう一度お試しください。');
            }
        };

        // アセスメント一覧を表示
        window.showAllAssessments = function() {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            if (Object.keys(assessments).length === 0) {
                content.innerHTML = `
                    <h2>アセスメント一覧</h2>
                    <div class="empty-state">
                        <h3>登録されているアセスメントはありません</h3>
                        <p>「新規アセスメント作成」から始めてください</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>アセスメント一覧</h2><div class="list-container">';

            Object.entries(assessments)
                .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                .forEach(([fileName, assessment]) => {
                    const childData = assessment.data;
                    listHTML += `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${childData.childName}（${childData.childNameKana || ''}）</h4>
                                <p>診断名: ${childData.diagnosis || 'なし'}</p>
                                <p>作成日: ${new Date(assessment.createdAt).toLocaleDateString('ja-JP')}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-primary" onclick="viewAssessment('${fileName}')">表示</button>
                            </div>
                        </div>
                    `;
                });

            listHTML += '</div>';
            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // 支援計画一覧を表示
        window.showAllSupportPlans = function() {
            const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            if (Object.keys(supportPlans).length === 0) {
                content.innerHTML = `
                    <h2>支援計画一覧</h2>
                    <div class="empty-state">
                        <h3>作成された支援計画はありません</h3>
                        <p>児童のアセスメントから「支援計画作成」をお試しください</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>支援計画一覧</h2><div class="list-container">';

            Object.entries(supportPlans)
                .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                .forEach(([fileName, plan]) => {
                    listHTML += `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${plan.childName}</h4>
                                <p>ファイル名: ${fileName}</p>
                                <p>作成日: ${new Date(plan.createdAt).toLocaleDateString('ja-JP')}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary" onclick="viewSupportPlan('${fileName}')">表示</button>
                            </div>
                        </div>
                    `;
                });

            listHTML += '</div>';
            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // 支援計画を表示
        window.viewSupportPlan = function(fileName) {
            const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
            const plan = supportPlans[fileName];
            if (plan) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = plan.html;
            }
        };

        // 成長記録一覧を表示
        window.showAllReports = function() {
            const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            const hasReports = Object.keys(dailyReports).length > 0;
            const hasReviews = Object.keys(reviews).length > 0;

            if (!hasReports && !hasReviews) {
                content.innerHTML = `
                    <h2>成長記録一覧</h2>
                    <div class="empty-state">
                        <h3>記録はまだありません</h3>
                        <p>児童のアセスメントから「日々の記録」または「成長振り返り」を作成してください</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>成長記録一覧</h2>';

            // 日々の記録
            if (hasReports) {
                listHTML += '<h3 style="margin: 20px 0 10px; color: #ff9800;">日々の記録</h3><div class="list-container">';
                Object.entries(dailyReports)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .forEach(([fileName, report]) => {
                        listHTML += `
                            <div class="list-item">
                                <div class="list-item-info">
                                    <h4>${report.childName}</h4>
                                    <p>活動: ${report.activity || '（詳細は記録内）'}</p>
                                    <p>作成日: ${new Date(report.createdAt).toLocaleDateString('ja-JP')}</p>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-tertiary" onclick="viewDailyReport('${fileName}')">表示</button>
                                </div>
                            </div>
                        `;
                    });
                listHTML += '</div>';
            }

            // 成長振り返り
            if (hasReviews) {
                listHTML += '<h3 style="margin: 20px 0 10px; color: #2196f3;">成長振り返り</h3><div class="list-container">';
                Object.entries(reviews)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .forEach(([fileName, review]) => {
                        listHTML += `
                            <div class="list-item">
                                <div class="list-item-info">
                                    <h4>${review.childName}</h4>
                                    <p>作成日: ${new Date(review.createdAt).toLocaleDateString('ja-JP')}</p>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-quaternary" onclick="viewReview('${fileName}')">表示</button>
                                </div>
                            </div>
                        `;
                    });
                listHTML += '</div>';
            }

            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // 日々の記録を表示
        window.viewDailyReport = function(fileName) {
            const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            const report = dailyReports[fileName];
            if (report) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = report.html;
            }
        };

        // 成長振り返りを表示
        window.viewReview = function(fileName) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
            const review = reviews[fileName];
            if (review) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = review.html;
            }
        };

        // Initialize
        loadChildren();
    </script>
</body>
</html>
