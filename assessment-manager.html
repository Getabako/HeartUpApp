<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ©ãƒ¼ã‚ºFC ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .main-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .action-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .action-card h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .action-card p {
            color: #666;
            font-size: 14px;
        }

        .children-list {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }

        .children-list h2 {
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .child-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            transition: border-color 0.3s;
        }

        .child-item:hover {
            border-color: #4caf50;
        }

        .child-info h3 {
            color: #333;
            margin-bottom: 8px;
        }

        .child-info p {
            color: #666;
            font-size: 14px;
            margin: 4px 0;
        }

        .child-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: opacity 0.3s;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .btn-secondary {
            background: #4caf50;
            color: white;
        }

        .btn-tertiary {
            background: #ff9800;
            color: white;
        }

        .btn-quaternary {
            background: #2196f3;
            color: white;
        }

        .btn-danger-small {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
            min-width: auto;
        }

        .btn-danger-small:hover {
            background: #ffcdd2;
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-content h2 {
            color: #2e7d32;
            margin-bottom: 20px;
        }

        .close-modal {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        /* ä¸€è¦§è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .list-item:hover {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .list-item-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .list-item-info p {
            color: #666;
            font-size: 13px;
            margin: 2px 0;
        }

        .list-item-actions {
            display: flex;
            gap: 10px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                min-height: auto;
            }

            .container > header,
            .main-actions,
            .children-list,
            .close-modal {
                display: none !important;
            }

            .modal {
                display: block !important;
                position: static;
                background: none;
                width: 100%;
                height: auto;
            }

            .modal-content {
                max-width: 100%;
                max-height: none;
                overflow: visible;
                width: 100%;
                padding: 0;
                border-radius: 0;
                box-shadow: none;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 28px;
            }

            .child-item {
                grid-template-columns: 1fr;
            }

            .child-actions {
                justify-content: flex-start;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .list-item-actions {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ã‚«ãƒ©ãƒ¼ã‚ºFC ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ãŠå­æ§˜ã®ç‰¹æ€§ç®¡ç†ãƒ»æ”¯æ´è¨ˆç”»ãƒ»æ—¥ã€…ã®è¨˜éŒ²ã‚’ä¸€å…ƒç®¡ç†</p>
        </header>

        <div class="main-actions">
            <div class="action-card" onclick="window.location.href='assessment/form-simple.html'">
                <h3>æ–°è¦ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä½œæˆ</h3>
                <p>æ–°ã—ã„ãŠå­æ§˜ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™</p>
            </div>
            <div class="action-card" onclick="showAllAssessments()">
                <h3>ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä¸€è¦§</h3>
                <p>ç™»éŒ²æ¸ˆã¿ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¾ã™</p>
            </div>
            <div class="action-card" onclick="showAllSupportPlans()">
                <h3>æ”¯æ´è¨ˆç”»ä¸€è¦§</h3>
                <p>ä½œæˆæ¸ˆã¿ã®æ”¯æ´è¨ˆç”»ã‚’ç¢ºèªã—ã¾ã™</p>
            </div>
            <div class="action-card" onclick="showAllReports()">
                <h3>æˆé•·è¨˜éŒ²ä¸€è¦§</h3>
                <p>æ—¥ã€…ã®è¨˜éŒ²ã¨æˆé•·ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ç¢ºèªã—ã¾ã™</p>
            </div>
        </div>

        <div class="children-list">
            <h2>ç™»éŒ²å…ç«¥ä¸€è¦§</h2>
            <div id="childrenContainer">
                <div class="empty-state">
                    <h3>ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…ç«¥ã¯ã„ã¾ã›ã‚“</h3>
                    <p>ã€Œæ–°è¦ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä½œæˆã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing assessment -->
    <div id="assessmentModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('assessmentModal')">&times;</span>
            <div id="assessmentContent"></div>
        </div>
    </div>

    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- config.jsã¯å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿èª­ã¿è¾¼ã‚€ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ï¼‰ -->
    <script>
        // æœ€åˆã«ç©ºã®API_CONFIGã‚’å®šç¾©ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
        window.API_CONFIG = {
            GEMINI_API_KEY: '',
            MODEL_NAME: 'gemini-2.0-flash-exp'
        };
    </script>
    <script src="config.js" onerror="console.log('config.js not found - using default API_CONFIG')"></script>
    <script src="google-drive-api.js"></script>
    <script src="gemini-api.js"></script>
    <script>
        // APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            geminiAPI.loadApiKey();
            loadChildren();
        });

        // Load and display children
        function loadChildren() {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const container = document.getElementById('childrenContainer');

            if (Object.keys(assessments).length === 0) {
                return;
            }

            container.innerHTML = '';

            Object.entries(assessments).forEach(([fileName, assessment]) => {
                const childData = assessment.data;
                const childItem = document.createElement('div');
                childItem.className = 'child-item';
                childItem.innerHTML = `
                    <div class="child-info">
                        <h3>${childData.childName}ï¼ˆ${childData.childNameKana}ï¼‰</h3>
                        <p>ç”Ÿå¹´æœˆæ—¥: ${childData.birthDate} | æ€§åˆ¥: ${childData.gender || 'æœªå›ç­”'}</p>
                        <p>è¨ºæ–­å: ${childData.diagnosis || 'ãªã—'}</p>
                        <p>ç™»éŒ²æ—¥: ${new Date(assessment.createdAt).toLocaleDateString('ja-JP')}</p>
                    </div>
                    <div class="child-actions">
                        <button class="btn btn-primary" onclick="viewAssessment('${fileName}')">ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆè¡¨ç¤º</button>
                        <button class="btn btn-secondary" onclick="generateSupportPlan('${fileName}')">æ”¯æ´è¨ˆç”»ä½œæˆ</button>
                        <button class="btn btn-tertiary" onclick="createDailyReport('${fileName}')">æ—¥ã€…ã®è¨˜éŒ²</button>
                        <button class="btn btn-quaternary" onclick="createReview('${fileName}')">æˆé•·æŒ¯ã‚Šè¿”ã‚Š</button>
                    </div>
                `;
                container.appendChild(childItem);
            });
        }

        window.viewAssessment = function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');
            content.innerHTML = assessment.html;
            modal.classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        window.generateSupportPlan = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const confirmMsg = `${assessment.data.childName}ã•ã‚“ã®æ”¯æ´è¨ˆç”»ã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
            if (!confirm(confirmMsg)) return;

            try {
                // æ—¥ä»˜é–¢é€£ã®å¤‰æ•°
                const today = new Date();
                const startDate = today.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, 'å¹´').replace(/å¹´(\d+)$/, 'æœˆ$1æ—¥');
                const endDate = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000).toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, 'å¹´').replace(/å¹´(\d+)$/, 'æœˆ$1æ—¥');

                // Generate support plan using Gemini API
                const prompt = `
ã‚ãªãŸã¯æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã®å…ç«¥ç™ºé”æ”¯æ´ç®¡ç†è²¬ä»»è€…ã§ã™ã€‚
ä»¥ä¸‹ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’åˆ†æã—ã€å…¬å¼æ§˜å¼ã«æº–æ‹ ã—ãŸå€‹åˆ¥æ”¯æ´è¨ˆç”»ã‚’JSONå½¢å¼ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
- å¿…ãšJSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆèª¬æ˜æ–‡ã¯ä¸è¦ï¼‰
- ã™ã¹ã¦ã®é …ç›®ã«å…·ä½“çš„ãªå†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„
- ã€Œãƒ¼ã€ã‚„ç©ºæ–‡å­—åˆ—ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„
- ã‚µãƒƒã‚«ãƒ¼ç™‚è‚²ã®æ–‡è„ˆã§è¨˜è¼‰ã—ã¦ãã ã•ã„

ã€å…ç«¥æƒ…å ±ã€‘
å…ç«¥å: ${assessment.data.childName}
è¨ºæ–­å: ${assessment.data.diagnosis || 'ç™ºé”ã«èª²é¡Œã®ã‚ã‚‹ãŠå­æ§˜'}

ã€ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆè©•ä¾¡çµæœã€‘
- å ´é¢ã‚„æŒ‡ç¤ºã®ç†è§£: ${assessment.data.situationEpisode || 'å€‹åˆ¥ã®çŠ¶æ³ã«å¿œã˜ãŸæ”¯æ´ãŒå¿…è¦'}
- å…±æ„Ÿæ€§: ${assessment.data.empathyEpisode || 'ä»–è€…ç†è§£ã®ç·´ç¿’ãŒå¿…è¦'}
- ç¤¾ä¼šçš„ãƒ«ãƒ¼ãƒ«: ${assessment.data.cooperation || 'é›†å›£æ´»å‹•ã§ã®æ”¯æ´ãŒå¿…è¦'}
- ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: ${assessment.data.communicationDetails || 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ”¯æ´ãŒå¿…è¦'}
- ã“ã ã‚ã‚Š: ${assessment.data.persistence || 'æŸ”è»Ÿæ€§ã®æ”¯æ´ãŒå¿…è¦'}
- æŒ‡ç¤ºã®å—ã‘å…¥ã‚Œ: ${assessment.data.instructionDetails || 'æŒ‡ç¤ºç†è§£ã®æ”¯æ´ãŒå¿…è¦'}
- é›†ä¸­åŠ›: ${assessment.data.concentrationDetails || 'é›†ä¸­åŠ›ã®ç¶­æŒæ”¯æ´ãŒå¿…è¦'}
- å¤šå‹•æ€§: ${assessment.data.hyperactivityDetails || 'æ´»å‹•é‡ã®èª¿æ•´æ”¯æ´ãŒå¿…è¦'}
- è¡å‹•æ€§: ${assessment.data.impulsivityDetails || 'è¡å‹•ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ”¯æ´ãŒå¿…è¦'}
- ãƒ‘ãƒ‹ãƒƒã‚¯: ${assessment.data.panicDetails || 'æ„Ÿæƒ…ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®æ”¯æ´ãŒå¿…è¦'}
- ç²—å¤§é‹å‹•: ${assessment.data.grossMotorDetails || 'é‹å‹•æ©Ÿèƒ½ã®æ”¯æ´ãŒå¿…è¦'}
- å¾®ç´°é‹å‹•: ${assessment.data.fineMotorDetails || 'æ‰‹å…ˆã®å™¨ç”¨ã•ã®æ”¯æ´ãŒå¿…è¦'}
- ãƒãƒ©ãƒ³ã‚¹: ${assessment.data.balanceDetails || 'ãƒãƒ©ãƒ³ã‚¹èƒ½åŠ›ã®æ”¯æ´ãŒå¿…è¦'}
- ç”Ÿæ´»ç¿’æ…£: ${assessment.data.dailyLivingDetails || 'ç”Ÿæ´»ç¿’æ…£ã®æ”¯æ´ãŒå¿…è¦'}
- å®¶åº­ã§ã®é…æ…®: ${assessment.data.familySupport || 'å®¶åº­ã¨ã®é€£æºãŒå¿…è¦'}

ã€å‡ºåŠ›å½¢å¼ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
{
  "selfIntent": "æœ¬äººã®ç”Ÿæ´»ã«å¯¾ã™ã‚‹æ„å‘ï¼ˆã‚µãƒƒã‚«ãƒ¼ã‚’æ¥½ã—ã¿ãŸã„ç­‰ï¼‰",
  "familyIntent": "å®¶æ—ã®ç”Ÿæ´»ã«å¯¾ã™ã‚‹æ„å‘ï¼ˆæ„Ÿæƒ…ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å­¦ã‚“ã§ã»ã—ã„ç­‰ï¼‰",
  "supportPolicy": "ç·åˆçš„ãªæ”¯æ´ã®æ–¹é‡ï¼ˆ200æ–‡å­—ç¨‹åº¦ï¼‰",
  "longTermGoal": "é•·æœŸç›®æ¨™ï¼ˆå…·ä½“çš„ãªé”æˆç›®æ¨™ï¼‰",
  "shortTermGoal": "çŸ­æœŸç›®æ¨™ï¼ˆ3ãƒ¶æœˆç¨‹åº¦ã§é”æˆã§ãã‚‹ç›®æ¨™ï¼‰",
  "selfSupport": [
    {
      "needs": "æœ¬äººã®ãƒ‹ãƒ¼ã‚º1ï¼ˆä¾‹ï¼šè‡ªåˆ†ã®æ„Ÿæƒ…ã‚’ç†è§£ã—è¡¨ç¾ã§ãã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ï¼‰",
      "goal": "å…·ä½“çš„ãªé”æˆç›®æ¨™1",
      "content": "æ”¯æ´å†…å®¹ï¼ˆ5é ˜åŸŸã¨ã®é–¢é€£ã‚’å«ã‚€å…·ä½“çš„ãªå†…å®¹ï¼‰",
      "period": "6ãƒ¶æœˆ",
      "staff": "ã‚«ãƒ©ãƒ¼ã‚ºFCã‚¹ã‚¿ãƒƒãƒ•ã€ä¿è­·è€…",
      "notes": "ç•™æ„äº‹é …ï¼ˆæœ¬äººã®å½¹å‰²ã‚’å«ã‚€ï¼‰",
      "priority": 1
    },
    {
      "needs": "æœ¬äººã®ãƒ‹ãƒ¼ã‚º2",
      "goal": "å…·ä½“çš„ãªé”æˆç›®æ¨™2",
      "content": "æ”¯æ´å†…å®¹2",
      "period": "6ãƒ¶æœˆ",
      "staff": "ã‚«ãƒ©ãƒ¼ã‚ºFCã‚¹ã‚¿ãƒƒãƒ•",
      "notes": "ç•™æ„äº‹é …2",
      "priority": 2
    },
    {
      "needs": "æœ¬äººã®ãƒ‹ãƒ¼ã‚º3",
      "goal": "å…·ä½“çš„ãªé”æˆç›®æ¨™3",
      "content": "æ”¯æ´å†…å®¹3",
      "period": "6ãƒ¶æœˆ",
      "staff": "ã‚«ãƒ©ãƒ¼ã‚ºFCã‚¹ã‚¿ãƒƒãƒ•",
      "notes": "ç•™æ„äº‹é …3",
      "priority": 3
    }
  ],
  "familySupport": {
    "needs": "å®¶æ—æ”¯æ´ã®ãƒ‹ãƒ¼ã‚º",
    "goal": "å…·ä½“çš„ãªé”æˆç›®æ¨™",
    "content": "æ”¯æ´å†…å®¹",
    "period": "6ãƒ¶æœˆ",
    "staff": "ã‚«ãƒ©ãƒ¼ã‚ºFCã‚¹ã‚¿ãƒƒãƒ•",
    "notes": "ç•™æ„äº‹é …"
  },
  "transitionSupport": {
    "needs": "ç§»è¡Œæ”¯æ´ã®ãƒ‹ãƒ¼ã‚º",
    "goal": "å…·ä½“çš„ãªé”æˆç›®æ¨™",
    "content": "æ”¯æ´å†…å®¹",
    "period": "6ãƒ¶æœˆ",
    "staff": "ã‚«ãƒ©ãƒ¼ã‚ºFCã‚¹ã‚¿ãƒƒãƒ•ã€å­¦æ ¡ã®å…ˆç”Ÿ",
    "notes": "ç•™æ„äº‹é …"
  }
}

JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

                const response = await geminiAPI.generateContent(prompt);

                // JSONã‚’æŠ½å‡º
                let planData;
                try {
                    const jsonMatch = response.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        planData = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('JSON not found in response');
                    }
                } catch (e) {
                    console.error('JSON parse error:', e);
                    alert('æ”¯æ´è¨ˆç”»ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    return;
                }

                // å…¬å¼æ§˜å¼ã®HTMLã‚’ç”Ÿæˆ
                const supportPlanHTML = generateOfficialSupportPlanHTML(assessment.data, planData, startDate, endDate);

                // Save support plan
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const planFileName = `${assessment.data.childName}_æ”¯æ´è¨ˆç”»_${new Date().toISOString().split('T')[0]}.html`;
                supportPlans[planFileName] = {
                    html: supportPlanHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    planData: planData,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('supportPlans', JSON.stringify(supportPlans));

                alert('æ”¯æ´è¨ˆç”»ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼');

                // Display the plan
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = supportPlanHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error generating support plan:', error);
                alert('æ”¯æ´è¨ˆç”»ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        };

        // å…¬å¼æ§˜å¼ã®æ”¯æ´è¨ˆç”»HTMLã‚’ç”Ÿæˆ
        function generateOfficialSupportPlanHTML(childData, planData, startDate, endDate) {
            const today = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '/');

            return `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${childData.childName}ã•ã‚“ã®å€‹åˆ¥æ”¯æ´è¨ˆç”»</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif; font-size: 12px; line-height: 1.4; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .header-left h1 { font-size: 18px; color: #333; margin-bottom: 5px; }
        .header-right { text-align: right; font-size: 11px; color: #666; }
        .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .info-table th, .info-table td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
        .info-table th { background: #f0f0f0; font-weight: bold; width: 120px; }
        .section-title { background: #ff9800; color: white; padding: 8px 12px; font-weight: bold; margin: 15px 0 10px; }
        .content-row { display: flex; margin-bottom: 10px; }
        .content-label { width: 150px; font-weight: bold; padding: 8px; background: #fff8e1; border: 1px solid #ddd; }
        .content-value { flex: 1; padding: 8px; border: 1px solid #ddd; border-left: none; }
        .support-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px; }
        .support-table th { background: #ff9800; color: white; padding: 8px; border: 1px solid #e65100; text-align: center; font-weight: bold; }
        .support-table td { padding: 8px; border: 1px solid #ddd; vertical-align: top; }
        .support-table .category { background: #fff8e1; font-weight: bold; text-align: center; width: 60px; }
        .support-table .needs { width: 120px; }
        .support-table .goal { width: 150px; }
        .support-table .content { width: 280px; }
        .support-table .period { width: 60px; text-align: center; }
        .support-table .staff { width: 100px; }
        .support-table .notes { width: 180px; }
        .support-table .priority { width: 40px; text-align: center; }
        .footer { margin-top: 30px; display: flex; justify-content: space-between; }
        .footer-left, .footer-right { width: 45%; }
        .signature-row { display: flex; margin-bottom: 10px; }
        .signature-label { width: 100px; }
        .signature-line { flex: 1; border-bottom: 1px solid #333; }
        @media print { body { padding: 0; background: white; } .container { box-shadow: none; padding: 15px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>${childData.childName}ã•ã‚“ã®å€‹åˆ¥æ”¯æ´è¨ˆç”»ï¼ˆä»£æ›¿æ”¯æ´ç”¨ï¼‰</h1>
            </div>
            <div class="header-right">
                <p>æ–½è¨­åï¼šã‚«ãƒ©ãƒ¼ã‚ºFCé³¥æ –</p>
                <p>åˆ©ç”¨ã‚µãƒ¼ãƒ“ã‚¹ï¼šæ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</p>
                <p>ä½œæˆæ—¥ï¼š${today}</p>
            </div>
        </div>

        <table class="info-table">
            <tr>
                <th>å—çµ¦è€…è¨¼ç•ªå·</th>
                <td style="width:150px;"></td>
                <th>é–‹å§‹æ—¥</th>
                <td style="width:120px;">${startDate}</td>
                <th>æœ‰åŠ¹æœŸé™</th>
                <td style="width:120px;">${endDate}</td>
                <th>ä½œæˆå›æ•°</th>
                <td style="width:60px;">1</td>
            </tr>
        </table>

        <div class="content-row">
            <div class="content-label">åˆ©ç”¨å…åŠã³å®¶æ—ã®<br>ç”Ÿæ´»ã«å¯¾ã™ã‚‹æ„å‘</div>
            <div class="content-value">
                <strong>æœ¬äººï¼š</strong>${planData.selfIntent}<br>
                <strong>å®¶æ—ï¼š</strong>${planData.familyIntent}
            </div>
        </div>

        <div class="content-row">
            <div class="content-label">ç·åˆçš„ãªæ”¯æ´ã®æ–¹é‡</div>
            <div class="content-value">${planData.supportPolicy}</div>
        </div>

        <div class="content-row">
            <div class="content-label">é•·æœŸç›®æ¨™ï¼ˆå†…å®¹ãƒ»æœŸé–“ç­‰ï¼‰</div>
            <div class="content-value">${planData.longTermGoal}</div>
            <div class="content-label" style="width:180px;border-left:none;">æ”¯æ´ã®æ¨™æº–çš„ãªæä¾›æ™‚é–“ç­‰<br>ï¼ˆæ›œæ—¥ãƒ»é »åº¦ã€æ™‚é–“ï¼‰</div>
        </div>

        <div class="content-row">
            <div class="content-label">çŸ­æœŸç›®æ¨™ï¼ˆå†…å®¹ãƒ»æœŸé–“ç­‰ï¼‰</div>
            <div class="content-value">${planData.shortTermGoal}</div>
            <div class="content-value" style="width:180px;border-left:none;">æ¯é€±æœˆãƒ»é‡‘æ›œæ—¥ 12:30ã€œ18:00<br>ä¼‘æ ¡æ—¥ 10:00ã€œ15:00</div>
        </div>

        <table class="support-table">
            <thead>
                <tr>
                    <th colspan="2">é …ç›®ï¼ˆæœ¬äººã®ãƒ‹ãƒ¼ã‚ºç­‰ï¼‰</th>
                    <th>å…·ä½“çš„ãªé”æˆç›®æ¨™</th>
                    <th>æ”¯æ´å†…å®¹<br>ï¼ˆå†…å®¹ãƒ»æ”¯æ´ã®æä¾›ä¸Šã®ãƒã‚¤ãƒ³ãƒˆãƒ»5é ˜åŸŸã¨ã®é–¢é€£æ€§ç­‰ï¼‰</th>
                    <th>é”æˆæ™‚æœŸ</th>
                    <th>æ‹…å½“è€…<br>æä¾›æ©Ÿé–¢</th>
                    <th>ç•™æ„äº‹é …<br>ï¼ˆæœ¬äººã®å½¹å‰²ã‚’å«ã‚€ï¼‰</th>
                    <th>å„ªå…ˆé †ä½</th>
                </tr>
            </thead>
            <tbody>
                ${planData.selfSupport.map((item, index) => `
                <tr>
                    ${index === 0 ? `<td class="category" rowspan="${planData.selfSupport.length}">æœ¬äººæ”¯æ´</td>` : ''}
                    <td class="needs">${item.needs}</td>
                    <td class="goal">${item.goal}</td>
                    <td class="content">${item.content}</td>
                    <td class="period">${item.period}</td>
                    <td class="staff">${item.staff}</td>
                    <td class="notes">${item.notes}</td>
                    <td class="priority">${item.priority}</td>
                </tr>
                `).join('')}
                <tr>
                    <td class="category">å®¶æ—æ”¯æ´</td>
                    <td class="needs">${planData.familySupport.needs}</td>
                    <td class="goal">${planData.familySupport.goal}</td>
                    <td class="content">${planData.familySupport.content}</td>
                    <td class="period">${planData.familySupport.period}</td>
                    <td class="staff">${planData.familySupport.staff}</td>
                    <td class="notes">${planData.familySupport.notes}</td>
                    <td class="priority"></td>
                </tr>
                <tr>
                    <td class="category">ç§»è¡Œæ”¯æ´</td>
                    <td class="needs">${planData.transitionSupport.needs}</td>
                    <td class="goal">${planData.transitionSupport.goal}</td>
                    <td class="content">${planData.transitionSupport.content}</td>
                    <td class="period">${planData.transitionSupport.period}</td>
                    <td class="staff">${planData.transitionSupport.staff}</td>
                    <td class="notes">${planData.transitionSupport.notes}</td>
                    <td class="priority"></td>
                </tr>
            </tbody>
        </table>

        <div class="footer">
            <div class="footer-left">
                <div class="signature-row">
                    <span class="signature-label">èª¬æ˜åŒæ„æ—¥</span>
                    <span>ä»¤å’Œã€€ã€€å¹´ã€€ã€€æœˆã€€ã€€æ—¥</span>
                </div>
                <div class="signature-row">
                    <span class="signature-label">ä¿è­·è€…æ°å</span>
                    <span class="signature-line"></span>
                </div>
            </div>
            <div class="footer-right">
                <p>ã‚«ãƒ©ãƒ¼ã‚ºFCé³¥æ –</p>
                <div class="signature-row">
                    <span class="signature-label">å…ç«¥ç™ºé”æ”¯æ´ç®¡ç†è²¬ä»»è€…</span>
                    <span style="margin-left:20px;">å²¡æœ¬ã€€é™¸ä½‘</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }

        window.createDailyReport = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const activity = prompt(`${assessment.data.childName}ã•ã‚“ã®æœ¬æ—¥ã®æ´»å‹•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
            if (!activity) return;

            const observation = prompt('æœ¬æ—¥ã®æ§˜å­ã‚„æ°—ã¥ã„ãŸã“ã¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!observation) return;

            try {
                // Get latest support plan
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const childPlans = Object.entries(supportPlans)
                    .filter(([key, plan]) => plan.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));

                const latestPlan = childPlans[0]?.[1];

                const prompt = `
å…ç«¥ç™ºé”æ”¯æ´ã®æ—¥ã€…ã®æŒ‡å°è¨˜éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

å…ç«¥å: ${assessment.data.childName}
æ—¥ä»˜: ${new Date().toLocaleDateString('ja-JP')}

ã€æœ¬æ—¥ã®æ´»å‹•ã€‘
${activity}

ã€è¦³å¯Ÿå†…å®¹ã€‘
${observation}

ã€å‚è€ƒæƒ…å ±ã€‘
ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆæƒ…å ±:
- è¨ºæ–­å: ${assessment.data.diagnosis || 'ãªã—'}
- ä¸»ãªç‰¹æ€§: ${assessment.data.situationEpisode}, ${assessment.data.communicationDetails}

${latestPlan ? `æ”¯æ´è¨ˆç”»ç›®æ¨™: ${latestPlan.html}` : ''}

ã€è¨˜éŒ²ã«å«ã‚ã‚‹å†…å®¹ã€‘
1. æ´»å‹•å†…å®¹
2. å…ç«¥ã®åå¿œã¨æ§˜å­
3. æ”¯æ´è¨ˆç”»ã¨ã®é–¢é€£
4. æˆé•·ãŒè¦‹ã‚‰ã‚ŒãŸç‚¹
5. ä»Šå¾Œã®æ”¯æ´ã§æ³¨æ„ã™ã¹ãç‚¹

HTMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€è¦‹ã‚„ã™ãæ•´ç†ã•ã‚ŒãŸæ—¥ã€…ã®è¨˜éŒ²ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
`;

                const reportHTML = await geminiAPI.generateContent(prompt);

                // Save daily report
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                const reportFileName = `${assessment.data.childName}_è¨˜éŒ²_${new Date().toISOString().split('T')[0]}.html`;
                dailyReports[reportFileName] = {
                    html: reportHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    activity: activity,
                    observation: observation,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('dailyReports', JSON.stringify(dailyReports));

                alert('æ—¥ã€…ã®è¨˜éŒ²ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼');

                // Display the report
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = reportHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error creating daily report:', error);
                alert('æ—¥ã€…ã®è¨˜éŒ²ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        };

        window.createReview = async function(fileName) {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const assessment = assessments[fileName];

            if (!assessment) {
                alert('ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const confirmMsg = `${assessment.data.childName}ã•ã‚“ã®æˆé•·ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ä½œæˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
            if (!confirm(confirmMsg)) return;

            try {
                // Get all related data
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');

                const childPlans = Object.entries(supportPlans)
                    .filter(([key, plan]) => plan.childName === assessment.data.childName);

                const childReports = Object.entries(dailyReports)
                    .filter(([key, report]) => report.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .slice(0, 10); // Last 10 reports

                const previousReviews = Object.entries(reviews)
                    .filter(([key, review]) => review.childName === assessment.data.childName)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt));

                const prompt = `
å…ç«¥ç™ºé”æ”¯æ´ã®æˆé•·ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

å…ç«¥å: ${assessment.data.childName}
ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}

ã€ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆæƒ…å ±ã€‘
è¨ºæ–­å: ${assessment.data.diagnosis || 'ãªã—'}
ä¸»ãªç‰¹æ€§:
- ${assessment.data.situationEpisode}
- ${assessment.data.communicationDetails}

ã€æ”¯æ´è¨ˆç”»ã€‘
${childPlans.map(([key, plan]) => plan.html).join('\n')}

ã€æœ€è¿‘ã®æ´»å‹•è¨˜éŒ²ï¼ˆç›´è¿‘10ä»¶ï¼‰ã€‘
${childReports.map(([key, report]) => `
æ—¥ä»˜: ${new Date(report.createdAt).toLocaleDateString('ja-JP')}
æ´»å‹•: ${report.activity}
è¦³å¯Ÿ: ${report.observation}
`).join('\n')}

${previousReviews.length > 0 ? `
ã€éå»ã®æŒ¯ã‚Šè¿”ã‚Šã€‘
${previousReviews[0][1].html}
` : ''}

ã€æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã«å«ã‚ã‚‹å†…å®¹ã€‘
1. ã“ã®æœŸé–“ã®å…¨ä½“çš„ãªæˆé•·ã®æ§˜å­
2. æ”¯æ´è¨ˆç”»ã®é”æˆçŠ¶æ³
3. ç‰¹ã«æˆé•·ãŒè¦‹ã‚‰ã‚ŒãŸé ˜åŸŸ
4. ã¾ã æ”¯æ´ãŒå¿…è¦ãªé ˜åŸŸ
5. ä»Šå¾Œã®æ”¯æ´ã®æ–¹å‘æ€§
6. ä¿è­·è€…ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

HTMLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€ã‚°ãƒ©ãƒ•ã‚„è¡¨ã‚’ä½¿ç”¨ã—ã¦è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
`;

                const reviewHTML = await geminiAPI.generateContent(prompt);

                // Save review
                const reviewFileName = `${assessment.data.childName}_æŒ¯ã‚Šè¿”ã‚Š_${new Date().toISOString().split('T')[0]}.html`;
                reviews[reviewFileName] = {
                    html: reviewHTML,
                    childName: assessment.data.childName,
                    fileName: fileName,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('reviews', JSON.stringify(reviews));

                alert('æˆé•·ã®æŒ¯ã‚Šè¿”ã‚ŠãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼');

                // Display the review
                const modal = document.getElementById('assessmentModal');
                const content = document.getElementById('assessmentContent');
                content.innerHTML = reviewHTML;
                modal.classList.add('active');
            } catch (error) {
                console.error('Error creating review:', error);
                alert('æˆé•·ã®æŒ¯ã‚Šè¿”ã‚Šã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        };

        // ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        window.showAllAssessments = function() {
            const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            if (Object.keys(assessments).length === 0) {
                content.innerHTML = `
                    <h2>ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
                    <div class="empty-state">
                        <h3>ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>ã€Œæ–°è¦ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä½œæˆã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2><div class="list-container">';

            Object.entries(assessments)
                .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                .forEach(([fileName, assessment]) => {
                    const childData = assessment.data;
                    const escapedFileName = fileName.replace(/'/g, "\\'");
                    listHTML += `
                        <div class="list-item" id="assessment-item-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <div class="list-item-info">
                                <h4>${childData.childName}ï¼ˆ${childData.childNameKana || ''}ï¼‰</h4>
                                <p>è¨ºæ–­å: ${childData.diagnosis || 'ãªã—'}</p>
                                <p>ä½œæˆæ—¥: ${new Date(assessment.createdAt).toLocaleDateString('ja-JP')}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-primary" onclick="viewAssessment('${escapedFileName}')">è¡¨ç¤º</button>
                                <button class="btn btn-danger-small" onclick="deleteAssessment('${escapedFileName}')" title="å‰Šé™¤">ğŸ—‘</button>
                            </div>
                        </div>
                    `;
                });

            listHTML += '</div>';
            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
        window.deleteAssessment = async function(fileName) {
            if (!confirm('ã“ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»é–¢é€£ã™ã‚‹æ”¯æ´è¨ˆç”»ã‚„æ´»å‹•è¨˜éŒ²ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“')) {
                return;
            }

            try {
                // localStorageã‹ã‚‰å‰Šé™¤
                const assessments = JSON.parse(localStorage.getItem('assessments') || '{}');
                delete assessments[fileName];
                localStorage.setItem('assessments', JSON.stringify(assessments));

                // Google Driveã‹ã‚‰ã‚‚å‰Šé™¤ã‚’è©¦ã¿ã‚‹
                if (typeof googleDriveAPI !== 'undefined' && googleDriveAPI.isInitialized()) {
                    try {
                        await googleDriveAPI.deleteFile(fileName);
                        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‰Šé™¤
                        const jsonFileName = fileName.replace('.html', '.json');
                        await googleDriveAPI.deleteFile(jsonFileName);
                    } catch (e) {
                        console.log('Google Driveã‹ã‚‰ã®å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—:', e);
                    }
                }

                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                // ä¸€è¦§ã‚’æ›´æ–°
                showAllAssessments();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // æ”¯æ´è¨ˆç”»ä¸€è¦§ã‚’è¡¨ç¤º
        window.showAllSupportPlans = function() {
            const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            if (Object.keys(supportPlans).length === 0) {
                content.innerHTML = `
                    <h2>æ”¯æ´è¨ˆç”»ä¸€è¦§</h2>
                    <div class="empty-state">
                        <h3>ä½œæˆã•ã‚ŒãŸæ”¯æ´è¨ˆç”»ã¯ã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>å…ç«¥ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã€Œæ”¯æ´è¨ˆç”»ä½œæˆã€ã‚’ãŠè©¦ã—ãã ã•ã„</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>æ”¯æ´è¨ˆç”»ä¸€è¦§</h2><div class="list-container">';

            Object.entries(supportPlans)
                .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                .forEach(([fileName, plan]) => {
                    const escapedFileName = fileName.replace(/'/g, "\\'");
                    listHTML += `
                        <div class="list-item">
                            <div class="list-item-info">
                                <h4>${plan.childName}</h4>
                                <p>ãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}</p>
                                <p>ä½œæˆæ—¥: ${new Date(plan.createdAt).toLocaleDateString('ja-JP')}</p>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary" onclick="viewSupportPlan('${escapedFileName}')">è¡¨ç¤º</button>
                                <button class="btn btn-danger-small" onclick="deleteSupportPlan('${escapedFileName}')" title="å‰Šé™¤">ğŸ—‘</button>
                            </div>
                        </div>
                    `;
                });

            listHTML += '</div>';
            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // æ”¯æ´è¨ˆç”»ã‚’å‰Šé™¤
        window.deleteSupportPlan = async function(fileName) {
            if (!confirm('ã“ã®æ”¯æ´è¨ˆç”»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
                delete supportPlans[fileName];
                localStorage.setItem('supportPlans', JSON.stringify(supportPlans));

                if (typeof googleDriveAPI !== 'undefined' && googleDriveAPI.isInitialized()) {
                    try {
                        await googleDriveAPI.deleteFile(fileName);
                        const jsonFileName = fileName.replace('.html', '.json');
                        await googleDriveAPI.deleteFile(jsonFileName);
                    } catch (e) {
                        console.log('Google Driveã‹ã‚‰ã®å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—:', e);
                    }
                }

                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                showAllSupportPlans();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // æ”¯æ´è¨ˆç”»ã‚’è¡¨ç¤º
        window.viewSupportPlan = function(fileName) {
            const supportPlans = JSON.parse(localStorage.getItem('supportPlans') || '{}');
            const plan = supportPlans[fileName];
            if (plan) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = plan.html;
            }
        };

        // æˆé•·è¨˜éŒ²ä¸€è¦§ã‚’è¡¨ç¤º
        window.showAllReports = function() {
            const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
            const modal = document.getElementById('assessmentModal');
            const content = document.getElementById('assessmentContent');

            const hasReports = Object.keys(dailyReports).length > 0;
            const hasReviews = Object.keys(reviews).length > 0;

            if (!hasReports && !hasReviews) {
                content.innerHTML = `
                    <h2>æˆé•·è¨˜éŒ²ä¸€è¦§</h2>
                    <div class="empty-state">
                        <h3>è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>å…ç«¥ã®ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã€Œæ—¥ã€…ã®è¨˜éŒ²ã€ã¾ãŸã¯ã€Œæˆé•·æŒ¯ã‚Šè¿”ã‚Šã€ã‚’ä½œæˆã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            let listHTML = '<h2>æˆé•·è¨˜éŒ²ä¸€è¦§</h2>';

            // æ—¥ã€…ã®è¨˜éŒ²
            if (hasReports) {
                listHTML += '<h3 style="margin: 20px 0 10px; color: #ff9800;">æ—¥ã€…ã®è¨˜éŒ²</h3><div class="list-container">';
                Object.entries(dailyReports)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .forEach(([fileName, report]) => {
                        const escapedFileName = fileName.replace(/'/g, "\\'");
                        listHTML += `
                            <div class="list-item">
                                <div class="list-item-info">
                                    <h4>${report.childName}</h4>
                                    <p>æ´»å‹•: ${report.activity || 'ï¼ˆè©³ç´°ã¯è¨˜éŒ²å†…ï¼‰'}</p>
                                    <p>ä½œæˆæ—¥: ${new Date(report.createdAt).toLocaleDateString('ja-JP')}</p>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-tertiary" onclick="viewDailyReport('${escapedFileName}')">è¡¨ç¤º</button>
                                    <button class="btn btn-danger-small" onclick="deleteDailyReport('${escapedFileName}')" title="å‰Šé™¤">ğŸ—‘</button>
                                </div>
                            </div>
                        `;
                    });
                listHTML += '</div>';
            }

            // æˆé•·æŒ¯ã‚Šè¿”ã‚Š
            if (hasReviews) {
                listHTML += '<h3 style="margin: 20px 0 10px; color: #2196f3;">æˆé•·æŒ¯ã‚Šè¿”ã‚Š</h3><div class="list-container">';
                Object.entries(reviews)
                    .sort((a, b) => new Date(b[1].createdAt) - new Date(a[1].createdAt))
                    .forEach(([fileName, review]) => {
                        const escapedFileName = fileName.replace(/'/g, "\\'");
                        listHTML += `
                            <div class="list-item">
                                <div class="list-item-info">
                                    <h4>${review.childName}</h4>
                                    <p>ä½œæˆæ—¥: ${new Date(review.createdAt).toLocaleDateString('ja-JP')}</p>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-quaternary" onclick="viewReview('${escapedFileName}')">è¡¨ç¤º</button>
                                    <button class="btn btn-danger-small" onclick="deleteReview('${escapedFileName}')" title="å‰Šé™¤">ğŸ—‘</button>
                                </div>
                            </div>
                        `;
                    });
                listHTML += '</div>';
            }

            content.innerHTML = listHTML;
            modal.classList.add('active');
        };

        // æ—¥ã€…ã®è¨˜éŒ²ã‚’è¡¨ç¤º
        window.viewDailyReport = function(fileName) {
            const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
            const report = dailyReports[fileName];
            if (report) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = report.html;
            }
        };

        // æ—¥ã€…ã®è¨˜éŒ²ã‚’å‰Šé™¤
        window.deleteDailyReport = async function(fileName) {
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                delete dailyReports[fileName];
                localStorage.setItem('dailyReports', JSON.stringify(dailyReports));

                if (typeof googleDriveAPI !== 'undefined' && googleDriveAPI.isInitialized()) {
                    try {
                        await googleDriveAPI.deleteFile(fileName);
                        const jsonFileName = fileName.replace('.html', '.json');
                        await googleDriveAPI.deleteFile(jsonFileName);
                    } catch (e) {
                        console.log('Google Driveã‹ã‚‰ã®å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—:', e);
                    }
                }

                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                showAllReports();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // æˆé•·æŒ¯ã‚Šè¿”ã‚Šã‚’è¡¨ç¤º
        window.viewReview = function(fileName) {
            const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
            const review = reviews[fileName];
            if (review) {
                const content = document.getElementById('assessmentContent');
                content.innerHTML = review.html;
            }
        };

        // æˆé•·æŒ¯ã‚Šè¿”ã‚Šã‚’å‰Šé™¤
        window.deleteReview = async function(fileName) {
            if (!confirm('ã“ã®æˆé•·æŒ¯ã‚Šè¿”ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }

            try {
                const reviews = JSON.parse(localStorage.getItem('reviews') || '{}');
                delete reviews[fileName];
                localStorage.setItem('reviews', JSON.stringify(reviews));

                if (typeof googleDriveAPI !== 'undefined' && googleDriveAPI.isInitialized()) {
                    try {
                        await googleDriveAPI.deleteFile(fileName);
                        const jsonFileName = fileName.replace('.html', '.json');
                        await googleDriveAPI.deleteFile(jsonFileName);
                    } catch (e) {
                        console.log('Google Driveã‹ã‚‰ã®å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—:', e);
                    }
                }

                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
                showAllReports();
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        };

        // Initialize
        loadChildren();
    </script>
</body>
</html>
